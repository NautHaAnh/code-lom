<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GSAP Observe Swipe Panels</title>

    <style>
        body {
            overscroll-behavior: none;
            min-height: 100vh;
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        .swipe-section {
            position: relative;
            height: 50vh;
            width: 100%;
            overflow: visible;
        }

        .swipe-section .panel {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            font-size: 48px;
            color: #fff;
            font-weight: 700;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
        }

        .vh-200 {
            height: 50vh !important;
        }

        .test {
            height: 50vh;
            background: olive;
            text-align: center;
            color: white;
            font-size: 40px;
            padding: 5rem;
            box-sizing: border-box;
        }

        .test a {
            display: inline-block;
            margin-top: 2rem;
            font-size: 20px;
            color: #fff;
            text-decoration: underline;
        }

        .red {
            background-color: red;
        }

        .purple {
            background-color: purple;
        }

        .blue {
            background-color: blue;
        }

        .orange {
            background-color: orange;
        }

        .green {
            background-color: green;
            display: grid;
            place-items: center;
            font-size: 48px;
            color: #fff;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <section class="test">
        Test with scrollable content above section using observer from GSAP observer
        gallery on Codepen.
        <br />
        <a id="jumpButton" href="#footer">Anchor</a>
    </section>

    <div class="swipe-section">
        <section class="panel red">ScrollTrigger.observe() section</section>
        <section class="panel purple x-100">Section 2</section>
        <section class="panel blue x-100">Section 3</section>
    </div>

    <div id="footer" class="green vh-200">Footer section</div>

    <!-- spacer -->

    <!-- GSAP CDN -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollToPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/Observer.min.js"></script>

    <script>
        console.clear();

        gsap.registerPlugin(ScrollTrigger, ScrollToPlugin, Observer);

        const button = document.getElementById("jumpButton");
        let scrollToClick = false;

        // Gsap Code
        let currentIndex = -1;
        let animating;
        let swipePanels = gsap.utils.toArray(".swipe-section .panel");

        button.addEventListener("click", (e) => {
            e.preventDefault();
            scrollToClick = true;
            currentIndex = swipePanels.length;

            gsap.set(swipePanels, { xPercent: 0 });

            gsap.to(window, {
                scrollTo: {
                    y: "#footer",
                    autoKill: true,
                },
                duration: 1,
                ease: "power2.out",
                onComplete: () => {
                    scrollToClick = false;
                },
            });
        });

        // set second panel two initial 100%
        gsap.set(".x-100", { xPercent: 100 });

        // set z-index levels for the swipe panels
        gsap.set(swipePanels, {
            zIndex: (i) => i,
        });

        // create an observer and disable it to start
        let intentObserver = ScrollTrigger.observe({
            type: "wheel,touch",
            onUp: () => !animating && gotoPanel(currentIndex + 1, true),
            onDown: () => !animating && gotoPanel(currentIndex - 1, false),
            wheelSpeed: -1, // to match mobile behavior, invert the wheel speed
            tolerance: 10,
            preventDefault: true,
            onPress: (self) => {
                // on touch devices like iOS, if we want to prevent scrolling, we must call preventDefault() on the touchstart
                if (ScrollTrigger.isTouch) self.event.preventDefault();
            },
        });
        intentObserver.disable();

        let preventScroll = ScrollTrigger.observe({
            preventDefault: true,
            type: "wheel,scroll",
            allowClicks: true,
            onEnable: (self) => (self.savedScroll = self.scrollY()), // save the scroll position
            onChangeY: (self) => self.scrollY(self.savedScroll), // refuse to scroll
        });
        preventScroll.disable();

        // handle the panel swipe animations
        function gotoPanel(index, isScrollingDown) {
            console.log(index, swipePanels.length);
            animating = true;

            // return to normal scroll if we're at the end or back up to the start
            if (
                (index === swipePanels.length && isScrollingDown) ||
                (index === -1 && !isScrollingDown)
            ) {
                intentObserver.disable();
                preventScroll.disable();
                animating = false;

                // move 1px beyond so it doesn't immediately retrigger onEnter/onEnterBack
                preventScroll.scrollY(
                    preventScroll.scrollY() + (index === swipePanels.length ? 1 : -1)
                );
                return;
            }

            // target the second panel, last panel?
            let target = isScrollingDown ? swipePanels[index] : swipePanels[currentIndex];

            gsap.to(target, {
                xPercent: isScrollingDown ? 0 : 100,
                duration: 0.75,
                onComplete: () => {
                    animating = false;
                },
            });

            currentIndex = index;
        }

        // pin swipe section and initiate observer
        ScrollTrigger.create({
            trigger: ".swipe-section",
            pin: true,
            anticipatePin: true,
            start: "top top",
            end: "+=50%",
            onEnter: (self) => {
                if (preventScroll.isEnabled === false && !scrollToClick) {
                    self.scroll(self.start);
                    preventScroll.enable();
                    intentObserver.enable();
                    gotoPanel(currentIndex + 1, true);
                }
            },
            onEnterBack: (self) => {
                if (preventScroll.isEnabled === false && !scrollToClick) {
                    self.scroll(self.start);
                    preventScroll.enable();
                    intentObserver.enable();
                    gotoPanel(currentIndex - 1, false);
                }
            },
        });
    </script>
</body>

</html>